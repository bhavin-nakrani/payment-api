{
  "info": {
    "name": "Payment API",
    "description": "Complete API collection for Payment API testing",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:7000",
      "type": "string"
    },
    {
      "key": "token",
      "value": "",
      "type": "string"
    },
    {
      "key": "accountNumber1",
      "value": "",
      "type": "string"
    },
    {
      "key": "accountNumber2",
      "value": "",
      "type": "string"
    },
    {
      "key": "transactionReference",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Authentication",
      "item": [
        {
          "name": "Register User",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 201\", function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test(\"Response has user object\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.user).to.exist;",
                  "    pm.expect(jsonData.user.email).to.exist;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"email\": \"{{$randomEmail}}\",\n    \"password\": \"SecurePass123!\",\n    \"firstName\": \"{{$randomFirstName}}\",\n    \"lastName\": \"{{$randomLastName}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "register"]
            }
          }
        },
        {
          "name": "Login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Token received\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.token).to.exist;",
                  "    pm.collectionVariables.set(\"token\", jsonData.token);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"email\": \"test@example.com\",\n    \"password\": \"SecurePass123!\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/login",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "login"]
            }
          }
        },
        {
          "name": "Get Current User",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/auth/me",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "me"]
            }
          }
        }
      ]
    },
    {
      "name": "Accounts",
      "item": [
        {
          "name": "Create Account 1",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 201\", function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "var jsonData = pm.response.json();",
                  "if (jsonData.account && jsonData.account.accountNumber) {",
                  "    pm.collectionVariables.set(\"accountNumber1\", jsonData.account.accountNumber);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"accountType\": \"CHECKING\",\n    \"currency\": \"USD\",\n    \"initialBalance\": \"5000.00\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/accounts",
              "host": ["{{baseUrl}}"],
              "path": ["api", "accounts"]
            }
          }
        },
        {
          "name": "Create Account 2",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData.account && jsonData.account.accountNumber) {",
                  "    pm.collectionVariables.set(\"accountNumber2\", jsonData.account.accountNumber);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"accountType\": \"SAVINGS\",\n    \"currency\": \"USD\",\n    \"initialBalance\": \"2000.00\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/accounts",
              "host": ["{{baseUrl}}"],
              "path": ["api", "accounts"]
            }
          }
        },
        {
          "name": "List Accounts",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/accounts",
              "host": ["{{baseUrl}}"],
              "path": ["api", "accounts"]
            }
          }
        },
        {
          "name": "Get Account Details",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/accounts/{{accountNumber1}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "accounts", "{{accountNumber1}}"]
            }
          }
        },
        {
          "name": "Get Account Balance",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/accounts/{{accountNumber1}}/balance",
              "host": ["{{baseUrl}}"],
              "path": ["api", "accounts", "{{accountNumber1}}", "balance"]
            }
          }
        }
      ]
    },
    {
      "name": "Transactions",
      "item": [
        {
          "name": "Transfer Funds",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 201\", function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "var jsonData = pm.response.json();",
                  "if (jsonData.transaction && jsonData.transaction.referenceNumber) {",
                  "    pm.collectionVariables.set(\"transactionReference\", jsonData.transaction.referenceNumber);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"sourceAccountNumber\": \"{{accountNumber1}}\",\n    \"destinationAccountNumber\": \"{{accountNumber2}}\",\n    \"amount\": \"250.00\",\n    \"description\": \"Test transfer from Postman\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/transactions/transfer",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "transfer"]
            }
          }
        },
        {
          "name": "Get Transaction Details",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/transactions/{{transactionReference}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "{{transactionReference}}"]
            }
          }
        },
        {
          "name": "List Account Transactions",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/transactions/account/{{accountNumber1}}?limit=50",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "account", "{{accountNumber1}}"],
              "query": [
                {
                  "key": "limit",
                  "value": "50"
                }
              ]
            }
          }
        },
        {
          "name": "Get Transaction Statistics",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/transactions/account/{{accountNumber1}}/statistics?from=2025-01-01&to=2025-12-31",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "account", "{{accountNumber1}}", "statistics"],
              "query": [
                {
                  "key": "from",
                  "value": "2025-01-01"
                },
                {
                  "key": "to",
                  "value": "2025-12-31"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Workflow Testing",
      "item": [
        {
          "name": "Check Transaction Workflow - Pending",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Transaction has workflow status\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.transaction.status).to.exist;",
                  "    console.log(\"Current Status: \" + jsonData.transaction.status);",
                  "});",
                  "",
                  "pm.test(\"Transaction details are present\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.transaction.referenceNumber).to.exist;",
                  "    pm.expect(jsonData.transaction.amount).to.exist;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/transactions/{{transactionReference}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "{{transactionReference}}"]
            },
            "description": "Check transaction workflow status. The transaction goes through these states:\n- **pending**: Initial state after creation\n- **processing**: Being processed (transition happens via message queue)\n- **completed**: Successfully completed\n- **failed**: Failed during processing\n- **reversed**: Reversed after completion"
          }
        },
        {
          "name": "Monitor Workflow - Poll Until Completed",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Transaction status check\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var status = jsonData.transaction.status;",
                  "    ",
                  "    console.log(\"Current Status: \" + status);",
                  "    ",
                  "    // Log workflow state details",
                  "    if (status === 'pending') {",
                  "        console.log(\"‚è≥ Transaction is pending - waiting for processing\");",
                  "    } else if (status === 'processing') {",
                  "        console.log(\"‚öôÔ∏è Transaction is being processed\");",
                  "    } else if (status === 'completed') {",
                  "        console.log(\"‚úÖ Transaction completed successfully\");",
                  "        console.log(\"Completed At: \" + jsonData.transaction.completedAt);",
                  "    } else if (status === 'failed') {",
                  "        console.log(\"‚ùå Transaction failed\");",
                  "        console.log(\"Failure Reason: \" + jsonData.transaction.failureReason);",
                  "    } else if (status === 'reversed') {",
                  "        console.log(\"üîÑ Transaction was reversed\");",
                  "        console.log(\"Reversal Reason: \" + jsonData.transaction.failureReason);",
                  "    }",
                  "    ",
                  "    pm.expect(status).to.be.oneOf(['pending', 'processing', 'completed', 'failed', 'reversed']);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/transactions/{{transactionReference}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "{{transactionReference}}"]
            },
            "description": "Use this request repeatedly to monitor workflow state changes. Run this multiple times to see the transaction progress through states:\n1. pending ‚Üí processing ‚Üí completed (success path)\n2. pending/processing ‚Üí failed (failure path)\n3. completed ‚Üí reversed (reversal path)"
          }
        },
        {
          "name": "Test Workflow - Completed State",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Transaction is in completed state\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var status = jsonData.transaction.status;",
                  "    ",
                  "    if (status === 'completed') {",
                  "        console.log(\"‚úÖ Transaction successfully completed\");",
                  "        console.log(\"Completed At: \" + jsonData.transaction.completedAt);",
                  "        pm.expect(jsonData.transaction.completedAt).to.exist;",
                  "    } else {",
                  "        console.log(\"Current status: \" + status);",
                  "        console.log(\"Transaction not yet completed. Current state: \" + status);",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/transactions/{{transactionReference}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "{{transactionReference}}"]
            },
            "description": "Verify that the transaction has reached the **completed** state. This happens after:\n1. Transaction created (pending)\n2. Picked up by message queue worker\n3. Transitioned to processing\n4. Funds transferred successfully\n5. Marked as completed with completedAt timestamp"
          }
        },
        {
          "name": "Test Workflow - Failed State",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Check for failed transaction\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var status = jsonData.transaction.status;",
                  "    ",
                  "    if (status === 'failed') {",
                  "        console.log(\"‚ùå Transaction failed as expected\");",
                  "        console.log(\"Failure Reason: \" + jsonData.transaction.failureReason);",
                  "        pm.expect(jsonData.transaction.failureReason).to.exist;",
                  "    } else {",
                  "        console.log(\"Current status: \" + status);",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/transactions/{{transactionReference}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "{{transactionReference}}"]
            },
            "description": "To test the **failed** state, create a transaction that will fail:\n- Transfer more than available balance\n- Transfer from account with insufficient funds\n- System error during processing\n\nThe transaction will transition: pending ‚Üí processing ‚Üí failed"
          }
        },
        {
          "name": "Create Transfer to Test Insufficient Balance (Will Fail)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData.transaction && jsonData.transaction.referenceNumber) {",
                  "    pm.collectionVariables.set(\"transactionReference\", jsonData.transaction.referenceNumber);",
                  "    console.log(\"Transaction created: \" + jsonData.transaction.referenceNumber);",
                  "    console.log(\"This transaction will likely fail due to insufficient balance\");",
                  "} else if (jsonData.error) {",
                  "    console.log(\"Expected error: \" + jsonData.error);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"sourceAccountNumber\": \"{{accountNumber2}}\",\n    \"destinationAccountNumber\": \"{{accountNumber1}}\",\n    \"amount\": \"99999.00\",\n    \"description\": \"Test transfer - will fail due to insufficient balance\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/transactions/transfer",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "transfer"]
            },
            "description": "Creates a transfer with an amount larger than the account balance. This will either:\n1. Be rejected immediately (validation error), or\n2. Be created and then fail during processing (workflow: pending ‚Üí processing ‚Üí failed)"
          }
        },
        {
          "name": "List All Transactions by Status",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"List transactions and group by status\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var transactions = jsonData.transactions || [];",
                  "    ",
                  "    var statusCounts = {",
                  "        pending: 0,",
                  "        processing: 0,",
                  "        completed: 0,",
                  "        failed: 0,",
                  "        reversed: 0",
                  "    };",
                  "    ",
                  "    transactions.forEach(function(tx) {",
                  "        if (statusCounts.hasOwnProperty(tx.status)) {",
                  "            statusCounts[tx.status]++;",
                  "        }",
                  "    });",
                  "    ",
                  "    console.log(\"\\nüìä Transaction Workflow Status Summary:\");",
                  "    console.log(\"‚è≥ Pending: \" + statusCounts.pending);",
                  "    console.log(\"‚öôÔ∏è  Processing: \" + statusCounts.processing);",
                  "    console.log(\"‚úÖ Completed: \" + statusCounts.completed);",
                  "    console.log(\"‚ùå Failed: \" + statusCounts.failed);",
                  "    console.log(\"üîÑ Reversed: \" + statusCounts.reversed);",
                  "    console.log(\"\\nTotal transactions: \" + transactions.length);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/transactions/account/{{accountNumber1}}?limit=100",
              "host": ["{{baseUrl}}"],
              "path": ["api", "transactions", "account", "{{accountNumber1}}"],
              "query": [
                {
                  "key": "limit",
                  "value": "100"
                }
              ]
            },
            "description": "Lists all transactions for an account and displays a summary of workflow states in the test results console."
          }
        }
      ]
    }
  ]
}